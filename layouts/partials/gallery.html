<section class="gallery">

  {{/* 1) Find a cover image from front matter, if it exists */}}
  {{ $cover := nil }}
  {{ with .Params.resources }}
    {{ range . }}
      {{ if .params.cover }}
        {{ $cover = $.Resources.GetMatch .src }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 2) If we found a cover, display it at the top */}}
  {{ if $cover }}
    {{ $coverThumb := $cover.Filter (slice images.AutoOrient (images.Process "fit 1600x1600")) }}
    <div class="cover-photo mb-6">
      <img
        src="{{ $coverThumb.RelPermalink }}"
        alt="Cover Photo"
        class="w-full rounded shadow"
      >
    </div>
  {{ end }}

  <div id="gallery" style="visibility: hidden; height: 1px; overflow: hidden">
    {{ $images := slice }}

    {{/* 3) Gather all images except any marked as hidden or used as cover */}}
    {{ range $image := where (.Resources.ByType "image") "Params.hidden" "ne" true }}
      {{ if or (not $cover) (ne $image.RelPermalink $cover.RelPermalink) }}
        {{ $title := "" }}
        {{ $date := "" }}

        {{ with $image.Exif }}
          {{ $date = .Date }}
          {{ with .Tags.ImageDescription }}
            {{ $title = . }}
          {{ end }}
        {{ end }}

        {{ if ne $image.Title $image.Name }}
          {{ $title = $image.Title }}
        {{ end }}

        {{ if $image.Params.Date }}
          {{ $date = time $image.Params.Date }}
        {{ end }}

        {{/* Add this imageâ€™s metadata to our $images slice */}}
        {{ $images = $images | append (dict
          "Name"  $image.Name
          "Title" $title
          "Date"  $date
          "image" $image
          "Params" $image.Params
        ) }}
      {{ end }}
    {{ end }}

    {{ $publishResources := default true .Params.build.publishResources }}

    {{/*
      4) Sort the $images by .Params.sort_by (default = "Name") 
      and .Params.sort_order (default = "asc"), then render 
      each as a PhotoSwipe-ready anchor/link
    */}}
    {{ range sort $images (.Params.sort_by | default "Name") (.Params.sort_order | default "asc") }}
      {{ $image := .image }}
      {{ $thumbnail := $image.Filter (slice images.AutoOrient (images.Process "fit 600x600")) }}
      {{ $full := $image.Filter (slice images.AutoOrient (images.Process "fit 1600x1600")) }}
      {{ $color := index $thumbnail.Colors 0 | default "transparent" }}

      <a
        class="gallery-item"
        href="{{ if $publishResources }}{{ $image.RelPermalink }}{{ else }}{{ $full.RelPermalink }}{{ end }}"
        data-pswp-src="{{ $full.RelPermalink }}"
        data-pswp-width="{{ $full.Width }}"
        data-pswp-height="{{ $full.Height }}"
        data-pswp-target="{{ $image.Name | urlize }}"
        title="{{ .Title }}"
        itemscope
        itemtype="https://schema.org/ImageObject"
        style="aspect-ratio: {{ $thumbnail.Width }} / {{ $thumbnail.Height }}"
      >
        <figure style="background-color: {{ $color }}; aspect-ratio: {{ $thumbnail.Width }} / {{ $thumbnail.Height }}">
          <img
            class="lazyload"
            width="{{ $thumbnail.Width }}"
            height="{{ $thumbnail.Height }}"
            data-src="{{ $thumbnail.RelPermalink }}"
            alt="{{ .Title }}"
          />
        </figure>
        <meta itemprop="contentUrl" content="{{ if $publishResources }}{{ $image.RelPermalink }}{{ else }}{{ $full.RelPermalink }}{{ end }}" />
        {{ with site.Params.Author }}
          <span itemprop="creator" itemtype="https://schema.org/Person" itemscope>
            <meta itemprop="name" content="{{ site.Params.Author.name }}" />
          </span>
        {{ end }}
      </a>
    {{ end }}
  </div>
</section>
